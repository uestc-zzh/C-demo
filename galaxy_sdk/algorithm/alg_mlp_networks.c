#include "alg_mlp_networks.h"

/* define the BP networks*/
#define NETWORKS_INPUT_SIZE         (20) /* input data feature dimension */
#define NETWORKS_LINNER1_SIZE       (32) /* hidden layer neuron number */
#define NETWORKS_BATCHNORMAL1D_SIZE (32)
#define NETWORKS_LINNER2_SIZE       (32)
#define NETWORKS_OUTPUT_SIZE        (5) /* class number */
#define EPS                         0.00001
#define FLT_MIN                     1.175494351e-38F

#define NET_NORMAL      0
#define NET_ERR_GENERIC -1

/* weight: reshape the original [row_num, column_num] matrix into
 * [row_num*column_num, 1] along columns */
typedef struct NetwoksLayer {
    uint16_t row_num;
    uint16_t column_num;
    const float *weight;
    const float *bias;
} NetwoksLayer;

typedef struct BpNetworks {
    NetwoksLayer linner_layer1;
    NetwoksLayer linner_layer2;

} BpNetworks;

static BpNetworks bp_networks;

//* changed weight
const float
    linner_layer1_weight[NETWORKS_INPUT_SIZE * NETWORKS_LINNER1_SIZE] = {
        0.3712641457772827,     0.24335841786622214,    -0.12178621304802602,
        0.5417781307355634,     -0.46526588924158313,   0.6214063514546335,
        0.23315617359874644,    0.49627817415299175,    -0.4660960389142995,
        -1.8334353829367132,    0.0369473026560671,     -0.2621517409387425,
        -0.1856465220659121,    -0.5641730363766353,    -0.2062062716318863,
        -0.1852770600215427,    -0.17167593827708855,   -2.9858943909242486,
        -2.822683612754941,     -4.898895625210313,     0.006065869015065914,
        -0.4465490571075301,    0.14462307663295026,    0.04543316897734937,
        0.014289898321027502,   0.13454980697781677,    0.4373922360517902,
        -2.1489754116855933,    -2.993779011387189,     -4.892290269653855,
        -1.4980694319796701,    -0.179965067513383,     -0.02099383984669775,
        -0.08043604029372672,   0.2973865097804927,     0.4864589325332593,
        0.06138247583497177,    -6.876156558687493,     -6.036961033975019,
        -6.9573842098249985,    -1.3820224268817687,    -0.41126571345463503,
        -0.6793771960094966,    -0.2936403641255581,    -0.4664017550972203,
        -0.35779823441926334,   0.5349237458789065,     0.6675917002504647,
        2.652352796317749,      8.082300007718269,      1.0504137663443864,
        0.06244662114419105,    0.20480940538734413,    -0.40727650687981204,
        -0.5281375531478463,    0.5031319111107817,     0.14287706663907332,
        10.995514282907578,     10.255770235132347,     10.553591172165905,
        0.18795337125973355,    -0.3472096870243723,    0.468083021491899,
        0.23247262611255484,    1.2177203974524973,     -0.272225410016425,
        -0.24222568931276886,   -3.753805277669786,     -3.2348403922556064,
        -4.944170210269409,     -0.6187012271080207,    0.20280043548366414,
        0.12788422995462406,    -0.03955963277810852,   0.02409552804766011,
        0.5332613489283249,     -0.024478080975928768,  -4.968288837973377,
        -4.295316685961039,     -5.191206218347803,     -0.02033694445973633,
        0.18301012640544306,    0.4464524203595226,     0.30494076855518654,
        -0.016283860926653165,  -0.25978954520675174,   -0.06022345719511301,
        -0.5983803961689093,    -1.3894969314203738,    -5.195725328145248,
        -0.7318932498150972,    -0.5336411917376969,    -0.3211977535394835,
        0.24084015146627097,    0.8974621517409073,     -0.47124378916778786,
        0.23409954403741934,    -7.490278262943887,     -7.4831473556898604,
        -6.616123292205393,     0.09309770693686091,    0.09069931692184567,
        0.17317384084369652,    0.37545902096501094,    -0.14205963074473493,
        0.6732333249715048,     -0.2392308721031395,    2.3052707341126584,
        -0.42791175411588517,   -1.0925129416101083,    -0.015617496733397898,
        -0.27060994921612136,   0.056631427138087935,   0.9332088604548107,
        0.11310700391342124,    -1.3971448273237383,    0.3796174381975223,
        -3.0364253609532024,    -3.6590358334135633,    -4.019448150230386,
        0.14452697305738937,    -0.29779396407476316,   0.20981463297611158,
        0.24799226920695233,    0.7574311420046895,     0.047264934733084275,
        -0.24758382632081027,   -4.929821748910456,     -5.722245765302825,
        -7.845529966792674,     -1.1722477827027848,    0.17967991545968423,
        -0.06142730173160731,   -0.15599275344214614,   -0.23980964429285442,
        0.16674163776673687,    0.6124421621424755,     -8.523950869233847,
        -7.887664825452285,     -9.356053333806607,     -0.20171440874889088,
        -0.2898905477513985,    -0.07027970941585397,   0.18838394450283338,
        -0.6377798311917601,    0.32323495038881905,    -0.08020970837146454,
        -0.23737221892576854,   0.48658163404585303,    -0.9021790510325862,
        -0.21937992256038688,   -0.27410168620745295,   -0.04966918426387174,
        0.21108817422881795,    0.781788072142743,      -0.7363052342476529,
        0.15280096303242074,    -1.2016961645455504,    -1.2440356049593224,
        -0.28667535590148086,   0.07605807729055625,    0.09906238323544894,
        0.33513584009961594,    0.25875899953427084,    0.21114309339054568,
        0.06607421248278737,    -0.16656615377827957,   -4.847289620084996,
        -4.796081159213821,     -7.440370118396701,     -0.6055647954152286,
        -0.3733714013415043,    -0.41807327728371074,   -0.2561963403275992,
        0.4034061307631161,     0.7092189729397149,     0.15206752010377292,
        -9.73042047100116,      -9.3243792559896,       -9.77111772978931,
        -0.05126340355074284,   0.09024121376246803,    -0.2054206087450284,
        0.12839312583221713,    0.4072511369419265,     -0.20226819579632851,
        -0.1192523788190541,    -1.0468383399766497,    -1.6744706438495032,
        -5.8897602004296585,    -0.33673793811372,      -0.20030074806048864,
        -0.23094096158587218,   -0.1910319284374238,    0.5210905783551709,
        0.4542134800322552,     -0.8350136967527882,    -9.74770300217048,
        -8.275580596568215,     -9.344474118768488,     -0.01216058671580445,
        -0.1162172342307988,    0.21018092047036338,    0.05562935230659795,
        0.09083933270123437,    0.2628616371732896,     -0.04826342604784034,
        -0.8152063118444762,    -0.5877597561569468,    -4.655811632455114,
        -0.06772565256174305,   -0.3499561186131121,    -0.4268176326140084,
        -0.3766681095513787,    0.60933047643391,       0.7694960715023311,
        -0.3577545488035847,    -7.707166496303092,     -6.854582351024066,
        -7.7534091020790274,    0.26986573066071445,    -0.033932740395451064,
        -0.24651438697593628,   0.00826977234166655,    0.5952422472995321,
        0.005333912695036546,   -0.18469014287227414,   3.5577205447687135,
        2.643413995423154,      -1.5341952922987656,    0.6178560096533234,
        -0.4021286586008469,    -0.24605405655887977,   0.13523918024272602,
        0.6516451794295229,     -0.3006853674885197,    -2.0083113401694845,
        -6.240018812787787,     -5.0080052801940225,    -7.221456148581583,
        0.34646429992072075,    -0.5506563463169372,    -0.08481981206916714,
        0.41802341069545357,    -0.12839966970229078,   0.3179047151641628,
        0.7685915793460888,     2.88667712745414,       1.533811927722592,
        1.3944323846114375,     0.061011841950569336,   0.16796790057985092,
        0.41125999949485686,    0.09578381139479704,    -0.7033252462701177,
        -0.15262466126724536,   -1.1690331784136674,    -1.2396681880909202,
        -0.8069378700954463,    -2.8207594567384255,    -0.02309182932075702,
        0.13333267602338014,    0.037441822734014,      -0.01934184218751594,
        0.005689279347797486,   0.036175326153079924,   -0.487713564673465,
        0.3094779793791356,     -1.374210872118845,     -5.5590689074463615,
        -0.523343807716792,     -0.07126247235247643,   -0.2175676987305504,
        0.5199737024074891,     0.7575268168284074,     -1.2325343048782322,
        -0.3011240450677978,    -8.200252873179954,     -8.332142454868237,
        -7.656157058579387,     -0.610044125335868,     0.3231489302281041,
        -0.6405387666686497,    -0.26465615826598715,   0.028794539915199625,
        -0.5703515370838045,    0.49323880042172885,    0.26989233602137086,
        -0.31370964672366564,   1.5928878955860095,     -1.1669617546365765,
        0.1713637854653156,     0.2596457412777513,     -0.20184085348847194,
        0.33133569058739787,    0.4731739846450421,     0.3786616004793024,
        1.6587494226955577,     1.143704440589547,      1.8728512172548186,
        -0.22342469912845728,   -0.28145486911055545,   0.27638539168851123,
        0.10661725166097209,    0.7542290865067416,     -0.1783757521519815,
        -0.2529370498358831,    -0.1580670227256679,    -0.6257423645271535,
        -2.2048871222817374,    -0.3664475490760328,    0.27294654909922,
        0.35746386510703365,    -0.4574589011411304,    -0.24400845758918813,
        -0.36135913781074797,   -0.6234748930066031,    -2.5222139631673666,
        -1.8225626149606515,    -4.356495080605477,     0.9371815922868822,
        0.5315733793727564,     -0.22446062715432433,   0.22134653467241808,
        0.2680021961752837,     0.2256650511318074,     0.08029122710963751,
        0.49389113560875897,    -0.5322579048080008,    -1.995196428957346,
        0.38109969755647816,    -0.17279008813945676,   0.1372990995756155,
        -0.8778978302328604,    -0.21375571155859735,   -0.5657324573458687,
        -0.5602277274052458,    -2.8641238133927107,    -2.8975667658512823,
        -4.594816597241839,     -0.08980865195665327,   0.7260210316438404,
        -0.3581088663940377,    0.08136765926685666,    -0.01610874472614531,
        0.24100336976089484,    -0.41866169148216575,   2.40896066193648,
        0.10506747804596646,    -2.0899530958268424,    0.0032531963096346294,
        -0.5310096404755089,    0.03408884919451,       0.496788317813182,
        0.15816264221093784,    -1.2503128313558312,    -0.45898174261162333,
        -5.196752573470971,     -4.5330159379141275,    -6.562951208399356,
        -0.0005436021561762836, -0.2506026488228292,    -0.2037292671276304,
        -0.18846489675133576,   -0.2600828377870935,    0.09027361294341969,
        -0.05149267842057128,   2.540814970582923,      0.4578013683739019,
        -2.2318696560908915,    -0.641662975013815,     -0.17446010646979823,
        0.15673765776417353,    0.4552955619933098,     0.6895713883711541,
        -1.9986615032344084,    -0.17925479463047622,   -5.6780934043316265,
        -5.668807435674415,     -7.066478348327286,     0.10107114405110955,
        -0.11721552434493035,   -0.19383168476023976,   0.05671425711544435,
        0.7008368773802874,     0.4761393360849992,     -0.0026551649954802796,
        1.3218044788755126,     -0.5525814020267372,    -1.331493315893906,
        -0.043594009775646723,  -0.05951440320810582,   0.08204688422026409,
        -1.1093969684893878,    -0.22310548426072796,   0.2934397235934927,
        -0.20839647474961084,   -5.268637238331858,     -4.701790415900725,
        -9.482740225079288,     -1.162942508397354,     -0.4073568582975564,
        -0.641039075931755,     -0.5427704725375945,    -0.1896544036594481,
        -0.7450332115969419,    0.11488018340823439,    0.06558933314325015,
        1.4469917036376474,     5.741180887880833,      1.08996697910098,
        0.149401373313897,      0.2383503159665255,     -0.5406659677319642,
        -0.2995670353977007,    0.46452713219886693,    0.2517897352109938,
        8.445399692562162,      7.815214712732193,      8.564075421047928,
        -0.3319103787609154,    -0.16808291595890737,   -0.3921025662259849,
        0.2500870717381973,     -0.73253803828317,      -0.3759425010234975,
        -0.01449924970877862,   3.586390862388608,      1.5848066835710393,
        1.1056522942448617,     -0.22010330358645372,   0.20638928834838166,
        0.20466002155560517,    0.3959863110036045,     -0.2856447703755539,
        -2.1602187622076467,    -0.4609178113755155,    -2.2643396997175604,
        -2.4614011681203825,    -4.015632043559335,     -0.20760176210929934,
        0.16801995340873008,    0.24174934232581954,    -0.47946988480119024,
        0.2337876096028074,     -0.21484318066467023,   -0.11978649352066255,
        -0.060699770136339495,  -0.3742509245053153,    2.039573465723559,
        -0.20813057882497937,   -0.04010024656212177,   0.300032254766565,
        0.4457200665709789,     -0.2722036269081298,    -0.16942218224439753,
        0.4430173042689801,     3.744986932964434,      3.255593191375467,
        3.965074583111253,      0.001282282304796762,   0.372737353983425,
        -0.08695833333334486,   0.3562878245246009,     -0.2813047859976338,
        -0.3105251639364018,    0.33321592508955666,    -1.2323667294296792,
        -0.1567660591927368,    -1.111705176906949,     0.5370165810204005,
        -0.0468949106135553,    0.08114155584865011,    0.4581078865376712,
        0.668782725626854,      -0.0016892741975789193, 0.7931475932200162,
        -1.1771104082043136,    -0.8314101933244096,    -0.23813348622804967,
        -0.5061792673585637,    0.42032659626587393,    -0.15998065205832893,
        0.29185004623060173,    0.2914889243372375,     -0.5891534669385172,
        0.08287582030319858,    -0.7780856584382215,    -0.5945285010027509,
        -2.282748086133431,     -0.8193235781261655,    -0.09811301031366303,
        -0.5471455568376238,    -0.08831161422213436,   0.7249427948147946,
        -0.19423854277765137,   0.5025737299542294,     -5.356808173887999,
        -5.099215675437491,     -3.683064948483425,     -0.054857885835482616,
        -0.14623817021363003,   0.16114804402985333,    0.16800280539769974,
        -0.9997165072721839,    0.480294070144211,      0.25790124807588005,
        0.03812324202316499,    0.3479318263986326,     -2.475737715117026,
        -0.22813116955033982,   0.24335449160654007,    -0.4068958704318392,
        0.7158458346072479,     -0.09527959171415946,   -0.10847176431620037,
        0.050942725285946434,   -3.6242662093349454,    -2.5873588430254766,
        -1.564384975904723,     0.1462028497186481,     0.5589509449221541,
        -0.35535890113256147,   0.005710427231134134,   0.35453959273996183,
        -0.2723372690754491,    0.8176570888407463,     -0.8829408943448233,
        -0.1774572068469057,    -0.8870872553733142,    0.15454563325723758,
        -0.06980496141763629,   0.23487232343318862,    0.3520705350131491,
        -0.024321005886015917,  -0.010995171890065287,  0.4829403531655044,
        -0.4472201976585422,    0.30041601253311,       -0.030060921459857514,
        -0.8244850368061271,    -0.532059908722758,     -1.071259019204349,
        0.024403934695678184,   -0.6356975611957077,    0.013580731332342489,
        0.14570006419950782,    1.8817863215113038,     1.6336949630541713,
        3.3615075867362108,     0.5140889743999509,     -0.35761753789128903,
        0.12440782134607467,    -0.14265081045765807,   -0.4500341967819299,
        0.7936774814194874,     -0.29146153545196873,   2.9432945453192905,
        2.738442177796763,      2.9552243018075446,     0.1927736099413192,
        -0.6705985056257874,    -0.400621016429497,     0.25223121796317594,
        0.08358231702219497,    0.19576594034930925,    0.2400405993225788,
        2.5513759250437777,     1.7255603868690788,     0.05665930962263013,
        0.481603968779153,      -0.005723008222455395,  -0.34871034789503147,
        -0.1650251566777705,    -0.5550488450320263,    0.11164073202571646,
        -2.415417753319169,     -3.0473956134308833,    -2.281253779768241,
        -4.734371140690229,     0.41152671768908583,    -0.07359527171313787,
        0.05651421559209737,    0.20188027634934227,    -0.096687426920619,
        0.07738530577126439,    -0.20750315844013625,   1.9427135825050519,
        1.5776602564183049,     -2.347895607745708,     0.37860700824502,
        -0.3035569728545768,    -0.34966623446979933,   0.17624989735949972,
        0.9745734608404045,     -0.5311010367896257,    -1.0824273061460492,
        -4.577071849634844,     -3.8679688957079423,    -3.5112492435944693,
        0.5007336961810861,     0.43500132158919397,    0.7417987241268335,
        0.2865358069615968,     -0.03254513253528537,   -0.3116889100664994,
        -0.6071367799139581,    -1.5536302327257343,    -0.6654639040346534,
        -0.8119465485074191,    -0.13340831069862785,   0.24563144320551444,
        0.17827318480250512,    -0.17325835610778959,   -0.5274525891076141,
        0.025145800208962652,   -0.13130811981270338,   0.42898257934010814,
        1.0145507947010703,     0.3122925320990464,     -0.18232725878211245,
        0.08944779795286344,    -0.06563651425244568,   0.16674594319127725,
        -0.24321046516253625,   0.020630182286998894,   -0.08349657403905203,
        1.13032796467376,       -2.158910320521961,     -5.087154613719029,
        -1.719961667182467,     -0.3474616704327088,    0.14421199471851998,
        0.4237423454370537,     0.38590442103029515,    -0.4515096699314558,
        -0.23900271221386243,   -7.3497324634041785,    -7.380075210191112,
        -8.005364437609549,
    };
const float linner_layer1_bias[NETWORKS_LINNER1_SIZE] = {
    -0.0058, 0.1315,  -0.1175, 0.1267,  0.1505,  0.1881, 0.0069, 0.1319,
    -0.0222, 0.1346,  0.0659,  -0.1702, -0.0170, 0.1301, 0.0093, -0.2225,
    0.2171,  0.0161,  -0.2100, 0.1753,  -0.0310, 0.1796, 0.1395, -0.0756,
    0.0391,  -0.0965, 0.1917,  0.1950,  0.1942,  0.0471, 0.1517, 0.1193
};
const float
    linner_layer2_weight[NETWORKS_LINNER1_SIZE * NETWORKS_LINNER2_SIZE] = {
        0.6527906934963017,  -0.809195855471603,   -3.9403092149185794,
        0.3432514968976729,  -3.364465498221224,   -1.493514896965031,
        0.527726690394482,   -2.7809542126882922,  -2.059708822356147,
        -3.3005927445243275, -2.8836461632226404,  -1.634840612069533,
        -2.0364039281543325, -2.4625359966900637,  -1.7773084525076244,
        1.17227550612997,    0.7637462689502974,   -0.004220545233515415,
        -2.248907843295682,  1.03941372773651,     -0.10915324799711101,
        -3.7706979400213347, 0.7635182421823372,   -0.5730735768501916,
        -3.5032741732888133, -1.8516627259981537,  0.26685990588195974,
        -4.156515703207717,  -1.2759521686983475,  -2.2108738414282176,
        0.4122318939618737,  -1.9204455765832626,  -0.5484795830623473,
        -3.317825552473439,  -1.0159888744536067,  0.55178148893599,
        0.3386411289922906,  -0.04164858617990804, -0.6869663159755719,
        1.4877877025781547,  -1.838790048787718,   -0.5056134819054471,
        0.08456606233755726, -1.182817175600988,   -2.2300795911118123,
        0.894473083372767,   -3.5010031629738796,  -0.657749030184021,
        0.1921278329994343,  -4.089977099545984,   0.5418494470556111,
        -2.275829039540615,  -4.9894897928860615,  -0.4749713479139841,
        -5.502120592502909,  1.542850626537382,    0.28466316753546655,
        0.629436892549024,   1.0635697007014437,   -4.5676767145533885,
        -2.0458136210486524, 1.9332958273354657,   -0.7497821860825422,
        -1.5669821731620772, -2.6892224464311645,  -0.9156652678562462,
        1.6044248965138588,  -3.291254850301825,   -1.4315543640873878,
        -2.012384414934442,  -3.315695683371774,   -0.8654235833510123,
        -3.018177695046877,  -0.9515758957969582,  -1.7401826671838052,
        -1.9996110616296552, 0.38618197550083316,  -2.0640124878077617,
        0.343234952492048,   -3.028874297024444,   -2.8189404135524385,
        -1.1182641597102971, -0.9529931428117138,  -2.6041823081808775,
        0.8916352524277023,  0.2947408173331574,   -0.04960044876597936,
        -3.430943379880576,  0.255249216368473,    -0.8050561691312348,
        -3.796969901667829,  0.7655650668977082,   -0.15025761248582084,
        -1.6931714410029965, 0.06639685995764795,  -2.225265927513462,
        -1.302078310328858,  0.724061314863353,    -1.4931103127370577,
        -0.8329331824035144, 0.19694361356741535,  1.0422740460035897,
        -1.109169522225111,  -0.8240127711705268,  1.5445102439753884,
        1.601230110328731,   1.357327645369097,    1.3109324834731788,
        0.489679746291102,   -0.2823248327377013,  0.3971317648896728,
        -1.3653960350129666, -1.0807836061085623,  0.6031700958578741,
        1.039035876372359,   0.03321023408217092,  -1.1505030823673748,
        0.8836011306596112,  -0.37542470440523557, -1.4166265789705785,
        0.5978926866884254,  -0.4305089546278505,  -2.024934925715851,
        0.348521357349698,   0.8612406611326489,   -0.7691443608501016,
        -1.8365457488404608, 1.9495129667114568,   -1.506263361804675,
        -1.13986090852146,   -1.5171901923693496,  -1.3166174160299415,
        -0.8095486894700619, -1.6229252168855404,  -1.2455944157097492,
        -1.097684223577615,  -0.9469844504555363,  -0.7497890785719892,
        -1.0679078019075543, -1.063062496090317,   -1.5469695519240678,
        -0.9039255396669964, -1.5636689992945103,  -0.9690703435956679,
        -1.5048723460789604, -1.2873048167197778,  -1.1486024143628837,
        -1.501824003824236,  -1.540678184126148,   -1.495996646301707,
        -1.7965822264396485, -0.9466492220245011,  -1.231214031399845,
        -1.6262663713351688, -0.6427783695506255,  -1.6344655849623366,
        -1.2148438873752845, -0.8804902061166731,  -1.6459375554440223,
        -1.1068754858552134,
    };
const float linner_layer2_bias[NETWORKS_LINNER2_SIZE] = { -0.4992, -0.9683,
                                                          -0.2705, -0.2313,
                                                          -1.8066 };

const float batch_normal_weight[NETWORKS_BATCHNORMAL1D_SIZE] = {
    4.5441, 3.3605, 2.9124, 3.2150, 4.9545, 1.0000, 3.4416, 3.8911,
    4.9683, 3.3955, 3.4918, 0.9543, 3.5710, 4.1361, 4.7173, 4.3815,
    2.5728, 3.7531, 3.5959, 2.2458, 3.8433, 2.8044, 3.2782, 3.4944
};
const float batch_normal_bias[NETWORKS_BATCHNORMAL1D_SIZE] = {
    0.1292,  -0.2476, 0.4926,  0.5641,  -0.2890, 0.7055,  0.2082, 0.9209,
    -0.4723, -0.3954, -0.2485, -0.3566, 0.4655,  -0.2244, 0.7129, -0.3534,
    0.3470,  0.1875,  0.0289,  -0.4340, 0.5643,  0.2832,  1.1789, -0.0813,
    -0.0972, 0.8567,  -0.0622, 1.1126,  -0.0549, 0.4531,  0.6333, -0.5426
};
const float batch_normal_running_mean[NETWORKS_BATCHNORMAL1D_SIZE] = {
    -125555.3547, -1935332.5238, -209142.3374,  672671.2796,   -883409.8720,
    1204093.8128, -954437.7905,  -263059.8550,  -722151.1557,  -1093356.3950,
    -526578.6393, -1012312.0374, 565815.9110,   -1332016.9654, -1205877.5776,
    -842251.7144, -172898.2852,  -1146826.8910, -2298303.0595, -787419.1011,
    -641026.2823, -2205402.1708, -419949.1899,  3735535.7483,  -1126348.4733,
    375584.6880,  2044530.2275,  -1396547.1357, -2423407.0063, -97035.6673,
    539153.7010,  -2685320.5457
};
const float batch_normal_running_var[NETWORKS_BATCHNORMAL1D_SIZE] = {
    4.1999e+12, 2.7869e+12, 3.0409e+12, 3.1614e+12, 2.2987e+12, 7.5758e+12,
    1.2084e+12, 3.1421e+12, 1.0016e+12, 2.4510e+12, 1.8371e+12, 7.5123e+12,
    6.4982e+12, 2.7300e+12, 2.4359e+12, 2.5530e+12, 6.4623e+12, 7.6919e+12,
    1.0483e+13, 3.5176e+12, 6.3851e+12, 1.0945e+13, 6.8923e+12, 2.4898e+13,
    1.3931e+12, 3.9913e+12, 7.2458e+12, 6.9325e+12, 2.3025e+13, 3.3410e+12,
    1.2388e+12, 6.1667e+12
};

const char *action_list[11] = {
    "jumping_squat", "jumping_jack", "jumping_lunge", "sit", "squat",
};
static int linear_calculation(NetwoksLayer *layer, LayerData *input_data,
                              LayerData *output_data)
{
    uint16_t i = 0, j = 0;
    float tmp_sum = 0.0f;

    if (!layer || !input_data || !output_data) {
        return NET_ERR_GENERIC;
    }

    if (input_data->size != layer->row_num ||
        output_data->size != layer->column_num) {
        return NET_ERR_GENERIC;
    }

    for (i = 0; i < output_data->size; i++) {
        tmp_sum = 0.0f;
        for (j = 0; j < layer->row_num; j += 5) {
            tmp_sum +=
                input_data->data[j] * layer->weight[i * layer->row_num + j];

            tmp_sum += input_data->data[j + 1] *
                       layer->weight[i * layer->row_num + j + 1];

            tmp_sum += input_data->data[j + 2] *
                       layer->weight[i * layer->row_num + j + 2];

            tmp_sum += input_data->data[j + 3] *
                       layer->weight[i * layer->row_num + j + 3];

            tmp_sum += input_data->data[j + 4] *
                       layer->weight[i * layer->row_num + j + 4];
        }

        for (; j < layer->row_num; ++j) {
            tmp_sum +=
                input_data->data[j] * layer->weight[i * layer->row_num + j];
        }

        tmp_sum += layer->bias[i];
        output_data->data[i] = tmp_sum;
    }

    return NET_NORMAL;
}

static int relu(LayerData *input_data)
{
    uint16_t i = 0;
    if (!input_data) {
        return NET_ERR_GENERIC;
    }
    for (i = 0; i < input_data->size; i++) {
        if (input_data->data[i] < 0.0f) {
            input_data->data[i] = 0.0f;
        }
    }
    return NET_NORMAL;
}

static int batch_normal1d(LayerData *input_data)
{
    uint16_t i = 0;
    for (i = 0; i < input_data->size; i += 4) {
        input_data->data[i] =
            ((input_data->data[i] - batch_normal_running_mean[i]) /
             sqrt(batch_normal_running_var[i] + EPS)) *
                batch_normal_weight[i] +
            batch_normal_bias[i];
        input_data->data[i + 1] =
            ((input_data->data[i + 1] - batch_normal_running_mean[i + 1]) /
             sqrt(batch_normal_running_var[i + 1] + EPS)) *
                batch_normal_weight[i + 1] +
            batch_normal_bias[i + 1];
        input_data->data[i + 2] =
            ((input_data->data[i + 2] - batch_normal_running_mean[i + 2]) /
             sqrt(batch_normal_running_var[i + 2] + EPS)) *
                batch_normal_weight[i + 2] +
            batch_normal_bias[i + 2];
        input_data->data[i + 3] =
            ((input_data->data[i + 3] - batch_normal_running_mean[i + 3]) /
             sqrt(batch_normal_running_var[i + 3] + EPS)) *
                batch_normal_weight[i + 3] +
            batch_normal_bias[i + 3];
    }
    for (; i < input_data->size; ++i) {
        input_data->data[i] =
            ((input_data->data[i] - batch_normal_running_mean[i]) /
             sqrt(batch_normal_running_var[i] + EPS)) *
                batch_normal_weight[i] +
            batch_normal_bias[i];
    }
    return NET_NORMAL;
}

int networks_init(void)
{
    memset(&bp_networks, 0, sizeof(BpNetworks));

    bp_networks.linner_layer1.row_num    = NETWORKS_INPUT_SIZE;
    bp_networks.linner_layer1.column_num = NETWORKS_LINNER1_SIZE;
    bp_networks.linner_layer1.weight     = linner_layer1_weight;
    bp_networks.linner_layer1.bias       = linner_layer1_bias;

    bp_networks.linner_layer2.row_num    = NETWORKS_LINNER1_SIZE;
    bp_networks.linner_layer2.column_num = NETWORKS_LINNER2_SIZE;
    bp_networks.linner_layer2.weight     = linner_layer2_weight;
    bp_networks.linner_layer2.bias       = linner_layer2_bias;

    return NET_NORMAL;
}

static ClassResult result_classification(LayerData *hidden_layer_output)
{
    uint16_t i = 0, j = 0;
    for (i = 0; i < hidden_layer_output->size; i++) {
        if (hidden_layer_output->data[i] > hidden_layer_output->data[j]) {
            j = i;
        }
    }
    return (ClassResult)j;
}

void dump_layer(LayerData *input_data)
{
    for (int i = 0; i < input_data->size; ++i) {
        printf("%f ", input_data->data[i]);
    }
    printf("\n\n");
}

int foward_process(LayerData *input_data, int16_t *class)
{
    float linner_layer1_output_data[NETWORKS_LINNER1_SIZE] = { 0.0f };
    float linner_layer2_output_data[NETWORKS_LINNER2_SIZE] = { 0.0f };
    LayerData linner_layer1_output;
    LayerData linner_layer2_output;

    linner_layer1_output.size = NETWORKS_LINNER1_SIZE;
    linner_layer1_output.data = linner_layer1_output_data;

    linner_layer2_output.size = NETWORKS_LINNER2_SIZE;
    linner_layer2_output.data = linner_layer2_output_data;

    float hidden_layer_output_data[NETWORKS_OUTPUT_SIZE] = { 0.0f };

    LayerData hidden_layer_output;
    hidden_layer_output.size = NETWORKS_OUTPUT_SIZE;
    hidden_layer_output.data = hidden_layer_output_data;

    int ret;

    ret = linear_calculation(&bp_networks.linner_layer1, input_data,
                             &linner_layer1_output);

    if (ret != NET_NORMAL) {
        printf("linnear1 wrong!\n");
        return ret;
    }
    ret = batch_normal1d(&linner_layer1_output);

    if (ret != NET_NORMAL) {
        printf("batch_normal1d wrong!\n");
        return ret;
    }
    ret = relu(&linner_layer1_output);

    if (ret != NET_NORMAL) {
        printf("relu wrong!\n");
        return ret;
    }

    ret = linear_calculation(&bp_networks.linner_layer2, &linner_layer1_output,
                             &linner_layer2_output);

    if (ret != NET_NORMAL) {
        printf("linnear2 wrong!\n");
        return ret;
    }

    *class = result_classification(&hidden_layer_output);
    printf("action:%s\n", action_list[*class]);
    return ret;
}
